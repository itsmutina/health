{% extends 'base.html' %}

{% block title %}Settings - Mental Health Journal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog"></i> Settings
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Profile Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user"></i> Profile
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" value="{{ user.first_name }}" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" value="{{ user.last_name }}" disabled>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" value="{{ user.email }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Timezone</label>
                        <input type="text" class="form-control" value="{{ user.timezone }}" disabled>
                    </div>
                    <a href="#" class="btn btn-outline-primary">Edit Profile</a>
                </form>
            </div>
        </div>

        <!-- Reminder Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell"></i> Reminders
                </h5>
            </div>
            <div class="card-body">
                <form id="reminderForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reminder Time</label>
                            <input type="time" 
                                   class="form-control" 
                                   id="reminderTime" 
                                   value="{{ settings.reminder_time|time:'H:i' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enable Reminders</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="reminderEnabled" 
                                       {% if settings.reminder_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="reminderEnabled">
                                    Send daily reminders
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Days of the Week</label>
                        <div class="row">
                            {% for day, name in day_choices %}
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               value="{{ day }}" 
                                               id="day{{ day }}"
                                               {% if day in settings.reminder_days %}checked{% endif %}>
                                        <label class="form-check-label" for="day{{ day }}">
                                            {{ name }}
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Reminder Settings</button>
                </form>
            </div>
        </div>

        <!-- Emotion Tags -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heart"></i> Emotion Tags
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Customize which emotions you want to track</p>
                <div class="emotion-chips">
                    {% for emotion in emotion_tags %}
                        <div class="emotion-chip {% if emotion in user_emotion_tags %}selected{% endif %}" 
                             onclick="toggleEmotionChip(this)">
                            <input type="checkbox" 
                                   name="emotions" 
                                   value="{{ emotion.id }}" 
                                   style="display: none;"
                                   {% if emotion in user_emotion_tags %}checked{% endif %}>
                            {{ emotion.name }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary mt-3" onclick="saveEmotionTags()" id="saveEmotionBtn">
                    <i class="fas fa-save"></i> Save Emotion Tags
                </button>
            </div>
        </div>

        <!-- Activity Tags -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-running"></i> Activity Tags
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Customize which activities you want to track</p>
                <div class="emotion-chips">
                    {% for activity in activity_tags %}
                        <div class="emotion-chip {% if activity in user_activity_tags %}selected{% endif %}" 
                             onclick="toggleEmotionChip(this)">
                            <input type="checkbox" 
                                   name="activities" 
                                   value="{{ activity.id }}" 
                                   style="display: none;"
                                   {% if activity in user_activity_tags %}checked{% endif %}>
                            {{ activity.name }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary mt-3" onclick="saveActivityTags()" id="saveActivityBtn">
                    <i class="fas fa-save"></i> Save Activity Tags
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Data Export -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download"></i> Export Data
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Download your data in various formats</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'accounts:export_data' %}?format=csv" class="btn btn-outline-primary">
                        <i class="fas fa-file-csv"></i> Download CSV
                    </a>
                    <a href="{% url 'accounts:export_data' %}?format=json" class="btn btn-outline-primary">
                        <i class="fas fa-file-code"></i> Download JSON
                    </a>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> Danger Zone
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">These actions cannot be undone</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteAllData()">
                        <i class="fas fa-trash"></i> Delete All Data
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteAccount()">
                        <i class="fas fa-user-times"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .emotion-chip {
        display: inline-block;
        padding: 8px 16px;
        margin: 4px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .emotion-chip:hover {
        background: #e9ecef;
        border-color: #6c5ce7;
        transform: translateY(-1px);
    }
    
    .emotion-chip.selected {
        background: #6c5ce7;
        color: white;
        border-color: #6c5ce7;
    }
    
    .btn-primary {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
    }
    
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Day choices for reminder settings
    const dayChoices = {
        0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday',
        4: 'Thursday', 5: 'Friday', 6: 'Saturday'
    };

    // Debug: Check if CSRF token is available
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
        console.log('CSRF token found:', csrfToken ? 'Yes' : 'No');
        if (csrfToken) {
            console.log('CSRF token value:', csrfToken.value);
        }
    });

    // Save reminder settings
    document.getElementById('reminderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const data = {
            reminder_time: document.getElementById('reminderTime').value,
            reminder_enabled: document.getElementById('reminderEnabled').checked,
            reminder_days: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value))
        };
        
        fetch('{% url "accounts:update_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Reminder settings saved successfully!', 'success');
            } else {
                showAlert('Error saving settings: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error saving settings. Please try again.', 'danger');
        });
    });

    // Save emotion tags
    function saveEmotionTags() {
        console.log('saveEmotionTags function called');
        const btn = document.getElementById('saveEmotionBtn');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        
        const selectedEmotions = Array.from(document.querySelectorAll('input[name="emotions"]:checked')).map(input => parseInt(input.value));
        console.log('Selected emotions:', selectedEmotions);
        
        fetch('{% url "accounts:update_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({emotions: selectedEmotions})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Emotion tags saved successfully!', 'success');
            } else {
                showAlert('Error saving emotion tags: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error saving emotion tags. Please try again.', 'danger');
        })
        .finally(() => {
            // Reset button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // Save activity tags
    function saveActivityTags() {
        console.log('saveActivityTags function called');
        const btn = document.getElementById('saveActivityBtn');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        
        const selectedActivities = Array.from(document.querySelectorAll('input[name="activities"]:checked')).map(input => parseInt(input.value));
        console.log('Selected activities:', selectedActivities);
        
        fetch('{% url "accounts:update_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({activities: selectedActivities})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Activity tags saved successfully!', 'success');
            } else {
                showAlert('Error saving activity tags: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error saving activity tags. Please try again.', 'danger');
        })
        .finally(() => {
            // Reset button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // Delete all data
    function deleteAllData() {
        if (confirm('Are you sure you want to delete all your journal entries? This cannot be undone.')) {
            // Implementation for deleting all data
            showAlert('This feature will be implemented soon.', 'warning');
        }
    }

    // Delete account
    function deleteAccount() {
        if (confirm('Are you sure you want to delete your account? This will permanently delete all your data and cannot be undone.')) {
            if (confirm('This is your final warning. Are you absolutely sure?')) {
                // Implementation for deleting account
                showAlert('This feature will be implemented soon.', 'warning');
            }
        }
    }

    // Show alert
    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('main .container').insertBefore(alert, document.querySelector('main .container').firstChild);
    }
</script>
{% endblock %}
